<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/perfil.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="shortcut icon" href="assets/imagens/favicon.ico" type="image/x-icon">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/cocon" rel="stylesheet">
    <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
  crossorigin="anonymous"
/>


   
</head>

<body>

    

    <main>

        <a href="area-restrita-login.html">
            <button class="btn-voltar">
                <i class="fa-solid fa-arrow-left"></i>
                <span>Voltar</span>
            </button>
        </a>

        <h1 id="h1-1">Acesse e edite informações sobre você!</h1>

        <div class="container-form">

            <div class="form">
  <form id="perfilForm" autocomplete="off">
    <p class="form-title">Seu Perfil</p>

 

    <!-- Campos do Perfil -->
    <div class="input-container">
      <label for="nome">Nome</label>
      <input type="text" id="nome" placeholder="Seu nome">
    </div>

    <div class="input-container">
      <label for="email" title="Somente leitura se seu backend não permitir alteração de e-mail">E-mail</label>
      <input type="email" id="email" placeholder="seu@email.com" disabled>
    </div>

    <div class="input-container">
      <label for="senha">Nova senha</label>
      <input type="password" id="senha" placeholder="Deixe em branco para não alterar">
    </div>

    <div class="input-container">
      <label for="confirmacaoSenha">Confirmar nova senha</label>
      <input type="password" id="confirmacaoSenha" placeholder="Repita a nova senha">
    </div>

    <div class="input-container" style="margin-top:12px;">
      <button type="button" class="submit">Atualizar perfil</button>
    </div>
  </form>
</div>

<!-- Modal de Edição de Imagem (fora do form/labels) -->
<div id="imageModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
      <h3 style="margin:0;">Cortar imagem</h3>
      <button type="button" class="close" aria-label="Fechar">&times;</button>
    </div>

    <div style="margin-top:10px;">
      <img id="imagePreview" alt="Pré-visualização" style="max-width:100%;display:block;">
    </div>

    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
      <button type="button" id="rotateLeft">Girar -90°</button>
      <button type="button" id="rotateRight">Girar +90°</button>
      <button type="button" id="zoomOut">- Zoom</button>
      <button type="button" id="zoomIn">+ Zoom</button>
      <button type="button" id="cropImage" style="margin-left:auto;">Aplicar corte</button>
    </div>
  </div>
</div>

<!-- Script (fora do modal e do form) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Use o mesmo padrão das outras páginas: sem /api no base, e concatene nas rotas
  const API_BASE = (window.API_BASE || 'http://localhost:8081').replace(/\/$/, '');
  const modal = document.getElementById('imageModal');
  const fileInput = document.getElementById('file');
  const imagePreview = document.getElementById('imagePreview');
  const avatarPreview = document.getElementById('avatarPreview');
  const closeBtn = document.querySelector('.close');
  const btnAtualizar = document.querySelector('.submit');
  const nomeEl = document.getElementById('nome');
  const emailEl = document.getElementById('email');

  let cropper = null;

  // Hidrata campos com dados do user salvos localmente
  try {
    const u = JSON.parse(localStorage.getItem('vm_user') || '{}');
    if (u.name && nomeEl) nomeEl.value = u.name;
    if (u.email && emailEl) emailEl.value = u.email;
    if (u.avatar_url && avatarPreview) {
      const t = u.avatar_updated_at ? ((u.avatar_url.includes('?') ? '&' : '?') + 't=' + u.avatar_updated_at) : '';
      avatarPreview.src = u.avatar_url + t;
    }
  } catch {}

  fileInput.addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        imagePreview.src = ev.target.result;
        modal.style.display = 'block';
        if (cropper) { cropper.destroy(); }
        cropper = new Cropper(imagePreview, {
          aspectRatio: 1,
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 1,
          cropBoxMovable: false,
          cropBoxResizable: false,
          guides: true,
          center: true,
          highlight: false
        });
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });

  document.getElementById('rotateLeft').addEventListener('click', function() { if (cropper) cropper.rotate(-90); });
  document.getElementById('rotateRight').addEventListener('click', function() { if (cropper) cropper.rotate(90); });
  document.getElementById('zoomIn').addEventListener('click', function() { if (cropper) cropper.zoom(0.1); });
  document.getElementById('zoomOut').addEventListener('click', function() { if (cropper) cropper.zoom(-0.1); });

  document.getElementById('cropImage').addEventListener('click', function() {
    if (!cropper) return;
    const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
    if (!canvas) return;

    avatarPreview.src = canvas.toDataURL('image/jpeg');
    modal.style.display = 'none';
    fileInput.value = '';

    canvas.toBlob(function(blob) {
      const tok = localStorage.getItem('vm_token');
      if (!tok) return;
      const fd = new FormData();
      fd.append('avatar', blob, 'avatar.jpg');
      fetch(API_BASE + '/api/user/avatar', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + tok },
        body: fd
      }).then(async (res) => {
        const j = await res.json().catch(()=>({}));
        if (res.ok && j.avatar_url) {
          if (window.VetMateUser?.saveAndHydrate) {
            window.VetMateUser.saveAndHydrate({ avatar_url: j.avatar_url, avatar_updated_at: Date.now() });
          }
          avatarPreview.src = j.avatar_url;
        } else {
          alert((j.error && j.error.message) || 'Erro ao enviar avatar');
        }
      }).catch(()=>{ alert('Erro network ao enviar avatar'); });
    }, 'image/jpeg');
  });

  function fecharModal() {
    modal.style.display = 'none';
    if (cropper) { cropper.destroy(); cropper = null; }
  }
  closeBtn.addEventListener('click', fecharModal);
  window.addEventListener('click', function(e) { if (e.target === modal) fecharModal(); });

  // Atualizar perfil
  btnAtualizar.addEventListener('click', function(e) {
    e.preventDefault();
    const senha = document.getElementById('senha').value;
    const confirmacaoSenha = document.getElementById('confirmacaoSenha').value;
    if (senha && senha !== confirmacaoSenha) { alert('As senhas não conferem'); return; }

    const tok = localStorage.getItem('vm_token');
    if (!tok) { alert('Usuário não autenticado'); return; }

    const payload = {};
    const nome = nomeEl.value?.trim();
    if (nome) payload.name = nome;
    if (senha) payload.password = senha;

    fetch(API_BASE + '/api/user', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + tok },
      body: JSON.stringify(payload)
    }).then(async (res) => {
      const j = await res.json().catch(()=>({}));
      if (res.ok && j.user) {
        if (window.VetMateUser?.saveAndHydrate) window.VetMateUser.saveAndHydrate(j.user);
        alert('Perfil atualizado');
      } else {
        alert((j.error && j.error.message) || 'Erro ao atualizar perfil');
      }
    }).catch(()=>{ alert('Erro network ao atualizar perfil'); });
  });
});
</script>

               <footer>

        <div id="container-footer">
            <div id="footer_contacts">
                <img src="assets/imagens/logo-vetmate.png" alt="logo-vetmate">
                <p>Sua parceira ideal.</p>

                <div id="footer_social_media">
                    <a href="https://www.instagram.com/pjvetmate/" class="footer-link" id="instagram">
                        <i class="fa-brands fa-instagram"></i>
                    </a>

                    <a href="https://x.com/pjvetmate" class="footer-link" id="x">
                        <i class="fa-brands fa-x-twitter"></i></i>
                    </a>

                    <a href="#" class="footer-link" id="linkedin">
                        <i class="fa-brands fa-linkedin"></i></i>
                    </a>
                </div>
            </div>

            <ul class="footer-list">
                <li>
                    <h3>Navegue</h3>
                </li>
                <li>
                    <a href="home.html" class="footer-link">Home</a>
                </li>
                <li>
                    <a href="institucional.html" class="footer-link">Institucional</a>
                </li>
                <li>
                    <a href="contato-e-sac.html" class="footer-link">Contato e SAC</a>
                </li>
                <li>
                    <a href="area-restrita.html" class="footer-link">Área Restrita</a>
                </li>
            </ul>

            <ul class="footer-list">
                <li>
                    <h3>Contato</h3>
                </li>
                <li>
                    <a href="#" class="footer-link">Email</a>
                </li>
                <li>
                    <a href="#" class="footer-link">WhatsApp</a>
                </li>
                <li>
                    <a href="#" class="footer-link">Telefone</a>
                </li>
            </ul>

            <div id="footer_subscribe">
                <h3>Subscribe</h3>

                <p>
                    Se inscreva em nossa newsletter para <br> receber todas as atualizações!
                </p>

                <div id="input_group">
                    <input type="email" id="email">
                    <button>
                        <i class="fa-regular fa-envelope"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="footer_copyright">
            &#169
            2024 | Todos os direitos reservados.
        </div>

    </footer>

  <script>window.API_BASE='http://localhost:8081/api';</script>
<script src="assets/js/user.js"></script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>


<script src="assets/js/perfil.js"></script>






</body>

</html>